<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Modern Tetris</title>
  <!-- uiEnhancements is imported inside main.ts; removed duplicate script include to prevent double MutationObservers & event handlers -->
  <!-- STEP 1: Scoreboard Typography & Text Effects (geometric tech font + metallic gradient + cyan glow bevel) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@600;700&display=swap" rel="stylesheet" />
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background: radial-gradient(circle at 30% 20%, #1f2535 0%, #0d1016 70%); color:#e5e7eb; -webkit-font-smoothing: antialiased; }
  #stage { padding:10px 12px; }
  .app-shell { display:flex; gap:18px; align-items:flex-start; justify-content:center; max-width:900px; margin:0 auto; }
    @media (max-width: 760px){ .app-shell { flex-direction:column; align-items:stretch; gap:20px; } #stage{ padding:12px 10px 40px; } }
    canvas { background:#06080d; display:block; image-rendering:pixelated; box-shadow:0 0 0 1px rgba(255,255,255,0.06),0 4px 16px -4px rgba(0,0,0,0.8); border-radius:6px; }
    @media (max-width: 380px) { canvas { width:240px; height:480px; } }
    /* Prevent accidental scroll / bounce when interacting */
    canvas, .control-grid, button { touch-action:none; -webkit-touch-callout:none; }
    #gameWrap { position:relative; }
    #overlay { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:54px; font-weight:700; letter-spacing:2px; font-family:inherit; background:rgba(0,0,0,0.55); backdrop-filter: blur(2px); color:#fff; opacity:0; transition:opacity .25s; pointer-events:none; border-radius:6px; }
    #overlay.visible { opacity:1; }
  .panel { width:250px; max-width:100%; display:flex; flex-direction:column; height:600px; }
  .panel-bottom { margin-top:10px; }
  .logo-wrap { text-align:center; margin:0 0 4px; }
  .logo-wrap img { width:100%; height:auto; max-height:180px; display:block; margin:0 auto; object-fit:contain; filter:drop-shadow(0 3px 10px rgba(0,0,0,0.55)); }
  .stats { display:flex; flex-direction:column; gap:8px; }
  .stat { background:linear-gradient(152deg, rgba(255,255,255,0.052), rgba(255,255,255,0.018)); padding:6px 8px 6px; border-radius:10px; position:relative; box-shadow:inset 0 0 0 1px rgba(255,255,255,0.045),0 1.5px 3.5px -2px rgba(0,0,0,0.55); display:flex; flex-direction:column; justify-content:flex-start; min-height:48px; }
  .score-primary { min-height:76px; padding:9px 12px 10px; border:1px solid rgba(120,156,255,0.35); box-shadow:0 4px 14px -6px rgba(48,84,255,0.55),0 0 0 1px rgba(255,255,255,0.10) inset,0 0 0 1px rgba(120,156,255,0.25); background:linear-gradient(155deg, rgba(120,156,255,0.28), rgba(120,156,255,0.08)); }
  .score-primary .stat-val { font-size:24px; }
  .mini-stats { display:grid; grid-template-columns:repeat(2,1fr); gap:6px; }
  .stat.mini { min-height:44px; padding:6px 7px 6px; }
  .high-badge { position:absolute; top:6px; right:8px; background:linear-gradient(135deg, rgba(255,255,255,0.18), rgba(255,255,255,0.05)); border:1px solid rgba(255,255,255,0.18); padding:2px 8px 3px; border-radius:20px; font-size:11px; font-weight:600; letter-spacing:.5px; display:flex; align-items:center; gap:4px; box-shadow:0 2px 4px -2px rgba(0,0,0,0.6); }
  .high-badge .icon { filter:drop-shadow(0 0 4px rgba(255,255,255,0.3)); }
  @keyframes badgePop { 0%{ transform:scale(0.9); box-shadow:0 0 0 0 rgba(255,220,120,0); } 30%{ transform:scale(1.15); box-shadow:0 0 12px 2px rgba(255,220,120,0.55);} 60%{ transform:scale(1); box-shadow:0 0 6px 1px rgba(255,220,120,0.35);} 100%{ transform:scale(1); box-shadow:0 0 0 0 rgba(255,220,120,0);} }
  .high-badge.badge-pop { animation: badgePop 1.1s ease; }
  /* Stat icon styles */
  .lines-card .stat-label:before { content:""; display:inline-block; width:8px; height:8px; background:linear-gradient(135deg,#4f7ff9,#8b5cf6); margin-right:4px; border-radius:2px; box-shadow:0 0 4px -1px rgba(79,127,249,0.7); }
  .level-card .stat-label:before { content:"⚡"; display:inline-block; margin-right:4px; font-size:11px; line-height:1; transform:translateY(-1px); filter:drop-shadow(0 0 4px rgba(255,226,140,0.45)); color:#f5d978; }
  .stat.emphasis { background:linear-gradient(155deg, rgba(120,156,255,0.22), rgba(120,156,255,0.07)); box-shadow:0 4px 14px -6px rgba(48,84,255,0.55), inset 0 0 0 1px rgba(255,255,255,0.08); }
  .stat-label { font-size:10px; text-transform:uppercase; letter-spacing:.65px; color:#b9bec6; font-weight:600; }
  .stat-val { display:block; font-size:15px; font-weight:700; margin-top:2px; font-variant-numeric: tabular-nums; font-feature-settings:'tnum','ss01'; line-height:1.05; }
    /* --- STEP 1 SCOREBOARD TYPOGRAPHY --- */
    :root {
      --score-text-grad: linear-gradient(to bottom,#9FB5D1 0%, #2E3A4F 55%, #141923 100%);
      --score-glow: #66D1FF;
      --score-bevel-hi: rgba(255,255,255,0.38);
      --score-bevel-shadow: rgba(0,0,0,0.72);
    }
    /* Apply only to numeric scoreboard values so other text remains readable */
    #scoreVal, #linesVal, #levelVal, #highVal {
      font-family: 'Oxanium', system-ui,-apple-system,'Segoe UI',Roboto,Inter,Arial,sans-serif;
      background: var(--score-text-grad);
      -webkit-background-clip: text; background-clip: text; color: transparent;
      letter-spacing: .7px;
      position: relative;
      /* Metallic bevel + cyan energized glow */
      text-shadow:
        -1px -1px 1px var(--score-bevel-hi), /* top-left bevel highlight */
        1px 1px 1px var(--score-bevel-shadow), /* bottom-right shadow */
        0 0 4px rgba(102,209,255,0.65),
        0 0 10px rgba(102,209,255,0.38),
        0 0 18px rgba(102,209,255,0.16);
    }
    /* Emphasize main score slightly larger for hierarchy */
    #scoreVal { font-size:28px; line-height:1; }
    /* Keep high score badge digits aligned but not overpowering */
    #highVal { font-size:14px; letter-spacing:.6px; }
    /* Accessibility: fallback color when background-clip unsupported */
    @supports not ((background-clip: text) or (-webkit-background-clip: text)) {
      #scoreVal, #linesVal, #levelVal, #highVal { color:#d9e2ec; text-shadow:0 0 6px rgba(102,209,255,0.55); }
    }
    /* Respect Windows High Contrast / forced-colors by reverting gradient */
    @media (forced-colors: active) {
      #scoreVal, #linesVal, #levelVal, #highVal { background:none; color:ButtonText; text-shadow:none; }
    }
    /* --- END STEP 1 --- */
    /* --- STEP 2: SCOREBOARD STEEL PANEL BOX STYLING --- */
    :root {
      --stat-metal-base: linear-gradient(160deg,#1a232d 0%,#0e141b 60%,#0b1016 100%);
      --stat-streaks: repeating-linear-gradient(135deg, rgba(255,255,255,0.08) 0 2px, rgba(255,255,255,0) 2px 7px);
      --stat-sheen: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
      --stat-rivet: radial-gradient(circle at center, rgba(165,185,205,0.6) 0 55%, rgba(30,40,52,0.15) 60%, rgba(0,0,0,0) 70%);
      --stat-cyan: #66D1FF;
    }
    /* Replace flat stat background with layered brushed steel + rivets */
    .stat {
      background:
        /* subtle bluish overlay retained for continuity */
        var(--stat-sheen),
        /* brushed streaks */
        var(--stat-streaks),
        /* corner rivets (4 placed via multiple radial gradients) */
        radial-gradient(circle at 8px 8px, rgba(165,185,205,0.55) 0 3px, rgba(0,0,0,0) 3px),
        radial-gradient(circle at calc(100% - 8px) 8px, rgba(165,185,205,0.55) 0 3px, rgba(0,0,0,0) 3px),
        radial-gradient(circle at 8px calc(100% - 8px), rgba(165,185,205,0.55) 0 3px, rgba(0,0,0,0) 3px),
        radial-gradient(circle at calc(100% - 8px) calc(100% - 8px), rgba(165,185,205,0.55) 0 3px, rgba(0,0,0,0) 3px),
        /* base metal */
        var(--stat-metal-base);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.05),
        inset 0 1px 2px rgba(255,255,255,0.12),
        inset -1px -1px 2px rgba(0,0,0,0.65),
        0 4px 10px -4px rgba(0,0,0,0.85),
        0 0 0 1px rgba(60,90,120,0.22);
      position:relative;
      overflow:hidden;
    }
    /* Stronger accent panel inherits steel but gets additional blue energy wash */
    .score-primary {
      background:
        linear-gradient(150deg, rgba(120,156,255,0.25), rgba(120,156,255,0.05)),
        var(--stat-streaks),
        var(--stat-metal-base);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.07),
        inset 0 1px 3px rgba(160,190,255,0.28),
        inset -1px -1px 2px rgba(0,0,0,0.7),
        0 4px 16px -6px rgba(48,84,255,0.6),
        0 0 0 1px rgba(120,156,255,0.28);
    }
    /* Thin cyan LED seam inside edge */
    .stat::before {
      content:""; position:absolute; inset:3px; border-radius:inherit; pointer-events:none;
      background:linear-gradient(90deg, rgba(102,209,255,0) 0%, rgba(102,209,255,0.55) 50%, rgba(102,209,255,0) 100%);
      opacity:.85; filter:drop-shadow(0 0 4px rgba(102,209,255,0.55)); mix-blend-mode:screen;
    }
    /* Inner bevel highlight & shadow blend to sell plate depth */
    .stat::after {
      content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
      background:
        linear-gradient(145deg, rgba(255,255,255,0.18), rgba(255,255,255,0) 40%),
        linear-gradient(325deg, rgba(0,0,0,0.55), rgba(0,0,0,0) 45%);
      mix-blend-mode:overlay; opacity:.85;
    }
    /* Prevent LED seam duplication on high score badge (keeps badge visual hierarchy clean) */
    .high-badge::before, .high-badge::after { content:none; }
    /* Mini stats: slightly toned down outer glow so hierarchy remains */
    .stat.mini { box-shadow:
      inset 0 0 0 1px rgba(255,255,255,0.05),
      inset 0 1px 2px rgba(255,255,255,0.1),
      inset -1px -1px 2px rgba(0,0,0,0.6),
      0 3px 8px -4px rgba(0,0,0,0.75),
      0 0 0 1px rgba(60,90,120,0.22); }
    /* Animation compatibility: maintain previous score-active glow layering without conflict */
    .score-active.score-primary { box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.07),
        inset 0 1px 3px rgba(160,190,255,0.35),
        inset -1px -1px 2px rgba(0,0,0,0.7),
        0 4px 18px -6px rgba(70,120,255,0.75),
        0 0 0 1px rgba(120,156,255,0.34),
        0 0 12px -2px rgba(120,156,255,0.55); }
    @media (forced-colors: active) {
      .stat, .score-primary { background:Canvas; box-shadow:0 0 0 1px ButtonText; }
      .stat::before, .stat::after { display:none; }
    }
    /* --- END STEP 2 --- */
    /* --- STEP 3: ICONOGRAPHY (metal star badge, metallic lightning, tetromino block icon) --- */
    /* High score star -> metallic + electric glow */
    .high-badge .icon {
      position:relative; display:inline-block; width:16px; height:16px; line-height:16px; text-align:center; font-size:14px; font-weight:700;
      background:linear-gradient(145deg,#f7fbff 0%,#c2d4e1 28%,#6d8698 55%,#2a3946 75%,#0d141a 100%);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:
        0 0 2px rgba(255,255,255,0.9),
        0 0 4px rgba(102,209,255,0.8),
        0 0 10px rgba(102,209,255,0.45),
        0 0 18px rgba(102,209,255,0.25);
      filter:drop-shadow(0 0 3px rgba(102,209,255,0.6));
    }
    .high-badge .icon::after { /* soft cyan aura */
      content:""; position:absolute; inset:-2px; pointer-events:none; border-radius:50%;
      background:radial-gradient(circle at 50% 55%, rgba(102,209,255,0.85), rgba(102,209,255,0) 65%);
      mix-blend-mode:screen; opacity:.9; filter:blur(2px);
    }
    /* Lightning (level) icon -> metallic core + glow */
    .level-card .stat-label:before {
      content:"⚡"; margin-right:4px; font-size:11px; line-height:1; display:inline-block; transform:translateY(-1px);
      background:linear-gradient(135deg,#fff2c2 0%,#f2d070 30%,#b88723 58%,#50370a 90%);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:
        0 0 2px rgba(255,230,140,0.85),
        0 0 6px rgba(255,210,90,0.65),
        0 0 12px rgba(255,200,70,0.35),
        0 0 20px rgba(255,180,50,0.25);
      filter:drop-shadow(0 0 4px rgba(255,200,90,0.55));
    }
    /* Lines icon -> mini glowing tetromino cell */
    .lines-card .stat-label:before {
      content:""; width:10px; height:10px; margin-right:4px; display:inline-block; border-radius:2px; position:relative; top:1px;
      background:
        linear-gradient(145deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.05) 45%, rgba(0,0,0,0.15) 100%),
        linear-gradient(145deg,#66d1ff 0%,#4f89ff 60%,#1b2f45 100%);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.55),
        inset 0 0 6px rgba(255,255,255,0.35),
        0 0 4px -1px rgba(102,209,255,0.8),
        0 0 10px -2px rgba(102,209,255,0.55);
    }
    .lines-card .stat-label:before::after { /* inner seam glow */
      content:""; position:absolute; inset:2px; border-radius:1px; pointer-events:none;
      background:radial-gradient(circle at 35% 30%, rgba(255,255,255,0.7), rgba(255,255,255,0) 65%);
      mix-blend-mode:screen; opacity:.9;
    }
    /* Adjust spacing so icons remain aligned after size tweaks */
    .stat-label { display:flex; align-items:center; }
    /* High contrast mode: revert decorative gradients */
    @media (forced-colors: active) {
      .high-badge .icon, .level-card .stat-label:before { background:none; color:ButtonText; filter:none; text-shadow:none; }
      .lines-card .stat-label:before { background:ButtonText; box-shadow:none; }
    }
    /* --- END STEP 3 --- */
    .stat.emphasis.pulse { animation:statPulse 0.65s ease; }
    @keyframes statPulse { 0%{ transform:scale(1); } 35%{ transform:scale(1.035); } 70%{ transform:scale(0.992); } 100%{ transform:scale(1); } }
  /* Score pop animation */
  @keyframes scorePop { 0%{ transform:scale(1); } 20%{ transform:scale(1.18); filter:drop-shadow(0 0 6px rgba(120,156,255,0.8)); } 50%{ transform:scale(1.05);} 100%{ transform:scale(1); filter:none; } }
  .score-pop { animation:scorePop .45s cubic-bezier(.45,.1,.2,1); }
  /* Lines flash */
  @keyframes linesFlash { 0%{ box-shadow:0 0 0 1px rgba(255,255,255,0.55),0 0 12px -2px rgba(120,156,255,0.9); background:linear-gradient(155deg, rgba(120,156,255,0.35), rgba(120,156,255,0.08)); } 100%{ box-shadow:inset 0 0 0 1px rgba(255,255,255,0.04),0 1.5px 3.5px -2px rgba(0,0,0,0.55); } }
  .lines-flash { animation:linesFlash .5s ease; }
  /* Start button running fade */
  #startBtn.running { opacity:.55; }
    /* Active score subtle breathing glow */
    @keyframes scoreActiveGlow { 0%{ box-shadow:0 4px 14px -6px rgba(48,84,255,0.55),0 0 0 1px rgba(120,156,255,0.25),0 0 8px -2px rgba(120,156,255,0.55) inset; }
      50%{ box-shadow:0 4px 16px -6px rgba(90,140,255,0.75),0 0 0 1px rgba(150,176,255,0.35),0 0 14px -2px rgba(140,170,255,0.85) inset; }
      100%{ box-shadow:0 4px 14px -6px rgba(48,84,255,0.55),0 0 0 1px rgba(120,156,255,0.25),0 0 8px -2px rgba(120,156,255,0.55) inset; } }
    .score-active.score-primary { animation: scoreActiveGlow 3s ease-in-out infinite; }
    /* READY electric pulse */
    @keyframes readyPulse { 0%{ text-shadow:0 0 8px rgba(120,156,255,0.55),0 0 18px rgba(94,140,255,0.25); opacity:0.85; }
      45%{ text-shadow:0 0 16px rgba(160,200,255,0.9),0 0 34px rgba(120,156,255,0.6); opacity:1; }
      100%{ text-shadow:0 0 8px rgba(120,156,255,0.55),0 0 18px rgba(94,140,255,0.25); opacity:0.85; } }
    #overlay.ready-pulse { animation: readyPulse 1.8s ease-in-out infinite; }
    /* Start button energy hover */
    .btn-primary:not(.running):hover { box-shadow:0 0 0 1px rgba(255,255,255,0.25) inset,0 0 12px 2px rgba(120,156,255,0.65),0 4px 10px -3px rgba(48,84,255,0.6); }
    /* Countdown animations */
    @keyframes countdownPulse { 0%{ transform:scale(.6); opacity:0; filter:blur(2px); }
      20%{ opacity:1; filter:blur(0); }
      55%{ transform:scale(1.05); }
      100%{ transform:scale(.2); opacity:0; filter:blur(4px); } }
    #overlay.counting { background:rgba(0,0,0,0.25); animation:none; }
    #overlay.counting .count-num { display:block; animation:countdownPulse 1s cubic-bezier(.55,.1,.35,1); font-size:110px; letter-spacing:4px; }
    #overlay.counting.go .count-num { font-size:78px; }
  #overlay.counting .count-num.go { background:linear-gradient(135deg,#5fa9ff,#9fabff); -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:0 0 14px rgba(120,156,255,0.75),0 0 28px rgba(120,156,255,0.45); }
  .progress-wrap { height:5px; margin-top:6px; border-radius:3px; background:rgba(255,255,255,0.12); overflow:hidden; position:relative; box-shadow:inset 0 0 0 1px rgba(0,0,0,0.4); }
  .progress-bar { position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(90deg,#4f7ff9,#8b5cf6); box-shadow:0 0 0 1px rgba(255,255,255,0.1),0 0 10px -2px #4f7ff9; transition:width .25s cubic-bezier(.4,.0,.2,1); }
    .delta { font-size:12px; font-weight:600; color:#10b981; opacity:0; transform:translateY(4px); transition: all .3s; }
    .delta.visible { opacity:1; transform:translateY(0); }
    .toast-layer { position:relative; min-height:40px; }
    .toast-layer .toast { position:absolute; right:0; top:0; background:rgba(17,24,39,0.9); padding:8px 14px 9px; border-radius:8px; font-size:13px; font-weight:600; letter-spacing:.5px; animation:toastIn .35s ease; box-shadow:0 4px 14px -6px rgba(0,0,0,0.9),0 0 0 1px rgba(255,255,255,0.06); backdrop-filter: blur(4px); }
    .toast.good { background:linear-gradient(135deg, rgba(34,197,94,0.85), rgba(34,197,94,0.65)); color:#022c16; }
    .toast.out { animation:toastOut .42s ease forwards; }
    @keyframes toastIn { 0%{ opacity:0; transform:translateY(-8px) scale(.95);} 100%{ opacity:1; transform:translateY(0) scale(1);} }
    @keyframes toastOut { 0%{ opacity:1; transform:translateY(0) scale(1);} 100%{ opacity:0; transform:translateY(-8px) scale(.93);} }
  .divider { height:1px; background:linear-gradient(90deg,rgba(255,255,255,0.14),rgba(255,255,255,0.02)); opacity:0.9; }
  button { cursor:pointer; outline:none; background:linear-gradient(150deg, rgba(255,255,255,0.10), rgba(255,255,255,0.02)); color:#fff; border:1px solid rgba(255,255,255,0.14); border-radius:7px; font-size:11px; padding:5px 8px 6px; font-weight:600; letter-spacing:.35px; font-family:inherit; transition:background .15s, transform .13s, border-color .18s, box-shadow .25s; position:relative; }
  .btn-primary { background:linear-gradient(140deg,#4f7ff9,#6f4ff9); border-color:#5a6ff5; box-shadow:0 4px 10px -4px rgba(80,120,255,0.55),0 0 0 1px rgba(255,255,255,0.08) inset; }
  .btn-primary:hover { background:linear-gradient(140deg,#6b8ffb,#855cfb); }
  .btn-primary:active { transform:translateY(2px); }
  .btn-secondary { background:linear-gradient(150deg, rgba(255,255,255,0.05), rgba(255,255,255,0.015)); border-color:rgba(255,255,255,0.14); opacity:0.85; }
  .btn-secondary:hover { background:linear-gradient(145deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04)); opacity:0.95; }
  .btn-secondary:active { transform:translateY(2px); }
    button:hover { background:linear-gradient(145deg, rgba(255,255,255,0.22), rgba(255,255,255,0.05)); }
    button:active { transform:translateY(2px); }
  .control-cluster { margin:6px auto 0; padding:6px 8px 8px; background:linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.015)); border:1px solid rgba(255,255,255,0.09); border-radius:10px; box-shadow:0 2px 4px -2px rgba(0,0,0,0.6), inset 0 0 0 1px rgba(255,255,255,0.04); }
  .control-grid { display:grid; grid-template-columns:repeat(3,28px); grid-template-rows:repeat(3,28px); gap:2px; justify-content:center; width:max-content; }
  .control-grid button { width:28px; height:28px; font-size:13px; font-weight:600; padding:0; display:flex; align-items:center; justify-content:center; }
  .control-grid .blank { pointer-events:none; opacity:0; }
  .foot-bar { margin-top:6px; font-size:10px; opacity:0.75; text-align:center; background:linear-gradient(145deg, rgba(255,255,255,0.06), rgba(255,255,255,0.015)); border:1px solid rgba(255,255,255,0.09); padding:4px 6px 5px; border-radius:6px; font-weight:500; letter-spacing:.4px; }
    .foot { font-size:12px; opacity:0.65; line-height:1.4; }
    @media (max-width: 520px){ .panel { width:100%; } .app-shell { gap:16px; } .control-grid { gap:6px; } .control-grid button { width:48px; height:48px; } #gameWrap { margin:0 auto; } }
    /* --- PANEL BUTTON / KEYBOARD UNIFICATION (Start, Reset, control arrows) --- */
    .panel-actions { display:flex; gap:6px; margin-top:4px; justify-content:center; }
    .panel-btn { flex:1; position:relative; font-family:inherit; font-size:11px; letter-spacing:.55px; font-weight:600; padding:8px 10px 9px; border:none; cursor:pointer; border-radius:9px; color:#dce5ef; background:var(--stat-metal-base); display:inline-flex; align-items:center; justify-content:center; isolation:isolate; }
    .panel-btn[data-variant="primary"] { color:#f5f9ff; }
    .panel-btn::before { content:""; position:absolute; inset:3px; border-radius:inherit; background:linear-gradient(90deg, rgba(102,209,255,0) 0%, rgba(102,209,255,0.45) 50%, rgba(102,209,255,0) 100%); opacity:.7; mix-blend-mode:screen; pointer-events:none; }
    .panel-btn::after { content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none; background:
        repeating-linear-gradient(135deg, rgba(255,255,255,0.07) 0 2px, rgba(255,255,255,0) 2px 7px),
        linear-gradient(145deg, rgba(255,255,255,0.15), rgba(255,255,255,0) 40%),
        linear-gradient(325deg, rgba(0,0,0,0.55), rgba(0,0,0,0) 45%);
      mix-blend-mode:overlay; opacity:.9; transition:opacity .25s; }
    .panel-btn { box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.06),
        inset 0 1px 2px rgba(255,255,255,0.12),
        inset -1px -1px 2px rgba(0,0,0,0.62),
        0 3px 8px -4px rgba(0,0,0,0.85),
        0 0 0 1px rgba(60,90,120,0.22); transition: box-shadow .28s, transform .18s, filter .25s; }
  /* Add rivets to panel buttons to match stat panels */
  .panel-btn { background:
    /* rivets */
    radial-gradient(circle at 8px 8px, rgba(165,185,205,0.55) 0 3px, rgba(0,0,0,0) 3px),
    radial-gradient(circle at calc(100% - 8px) 8px, rgba(165,185,205,0.55) 0 3px, rgba(0,0,0,0) 3px),
    radial-gradient(circle at 8px calc(100% - 8px), rgba(165,185,205,0.55) 0 3px, rgba(0,0,0,0) 3px),
    radial-gradient(circle at calc(100% - 8px) calc(100% - 8px), rgba(165,185,205,0.55) 0 3px, rgba(0,0,0,0) 3px),
    /* brushed streaks */
    repeating-linear-gradient(135deg, rgba(255,255,255,0.07) 0 2px, rgba(255,255,255,0) 2px 7px),
    var(--stat-metal-base);
  }
    .panel-btn:hover { box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.09),
        inset 0 1px 3px rgba(180,210,255,0.28),
        inset -1px -1px 2px rgba(0,0,0,0.68),
        0 4px 14px -5px rgba(100,140,255,0.55),
        0 0 0 1px rgba(120,156,255,0.30),
        0 0 10px -2px rgba(120,156,255,0.42); }
    .panel-btn:active { transform:translateY(2px); }
    #startBtn.running { opacity:.65; filter:saturate(.85); }
    /* Control grid button restyle */
    .control-grid button { background:var(--stat-metal-base); border:none; border-radius:7px; position:relative; color:#f0f6ff; box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.05),
        inset 0 1px 2px rgba(255,255,255,0.10),
        inset -1px -1px 2px rgba(0,0,0,0.58),
        0 2px 6px -3px rgba(0,0,0,0.85),
        0 0 0 1px rgba(60,90,120,0.22); transition: box-shadow .25s, transform .15s; }
    .control-grid button::before { content:""; position:absolute; inset:3px; border-radius:inherit; background:linear-gradient(90deg, rgba(102,209,255,0) 0%, rgba(102,209,255,0.4) 55%, rgba(102,209,255,0) 100%); mix-blend-mode:screen; opacity:.7; pointer-events:none; }
    .control-grid button::after { content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none; background:
        linear-gradient(145deg, rgba(255,255,255,0.12), rgba(255,255,255,0) 38%),
        linear-gradient(325deg, rgba(0,0,0,0.52), rgba(0,0,0,0) 45%); mix-blend-mode:overlay; opacity:.85; }
    .control-grid button:hover { box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.085),
        inset 0 1px 3px rgba(180,210,255,0.25),
        inset -1px -1px 2px rgba(0,0,0,0.6),
        0 2px 10px -3px rgba(90,140,255,0.55),
        0 0 0 1px rgba(120,156,255,0.28); }
    .control-grid button:active { transform:translateY(2px); }
    .control-cluster { width:100%; text-align:center; }
    .control-grid { margin:0 auto; }
    @media (forced-colors: active) { .panel-btn, .control-grid button { background:Canvas; box-shadow:0 0 0 1px ButtonText; } .panel-btn::before, .panel-btn::after, .control-grid button::before, .control-grid button::after { display:none; } }
    /* --- END PANEL BUTTON / KEYBOARD UNIFICATION --- */
  /* CENTER LABELS & UNIFY MINI STAT COLOR WITH PANEL BUTTONS */
  .stat-top { display:flex; justify-content:center; align-items:center; margin-top:2px; }
  .stat-top .stat-label { justify-content:center; }
  .stat-label { width:100%; justify-content:center; }
  /* Prevent delta from shifting center; absolute position it under label area right side */
  #score .delta { position:absolute; right:10px; top:8px; }
  /* Lines & Level adopt same darker steel tone as panel buttons (remove extra blue wash) */
  .stat.mini.lines-card, .stat.mini.level-card { background:
    radial-gradient(circle at 8px 8px, rgba(165,185,205,0.55) 0 3px, rgba(0,0,0,0) 3px),
    radial-gradient(circle at calc(100% - 8px) 8px, rgba(165,185,205,0.55) 0 3px, rgba(0,0,0,0) 3px),
    radial-gradient(circle at 8px calc(100% - 8px), rgba(165,185,205,0.55) 0 3px, rgba(0,0,0,0) 3px),
    radial-gradient(circle at calc(100% - 8px) calc(100% - 8px), rgba(165,185,205,0.55) 0 3px, rgba(0,0,0,0) 3px),
    /* unified diagonal streak intensity to match buttons */
    repeating-linear-gradient(140deg, rgba(255,255,255,0.085) 0 2px, rgba(255,255,255,0) 2px 7px),
    var(--stat-metal-base); }
  /* Adjust padding to better center labels vertically */
  .stat.mini { padding-top:8px; }
  #score.stat { padding-top:12px; }
  /* Center numeric values for mini stats & primary score */
  #scoreVal, #linesVal, #levelVal { display:block; width:100%; text-align:center; }
  /* Ensure mini stat internal layout vertical stack */
  .stat.mini { display:flex; flex-direction:column; align-items:center; }
  .stat.mini .stat-label { order:0; }
  .stat.mini .stat-val { order:1; margin-top:2px; }
  /* Slight adjustment to score card value to align center visually with glow */
  #scoreVal { margin-top:4px; }
  /* Icon spacing after centering */
  .lines-card .stat-label:before, .level-card .stat-label:before { margin-right:6px; }
  /* High contrast: keep centering but simplify backgrounds */
  @media (forced-colors: active){ .stat-top { justify-content:center; } .stat.mini.lines-card, .stat.mini.level-card { background:Canvas; } }
    /* --- STEP 4: PANEL LIGHTNING GLOW + CRACKLE OVERLAY --- */
    :root {
      --panel-glow-cyan: #66d1ff;
      --panel-glow-soft: rgba(102,209,255,0.55);
    }
    @keyframes panelLightningFlicker {
      0% { box-shadow: inset 0 0 0 1px rgba(255,255,255,0.07), inset 0 1px 3px rgba(160,190,255,0.28), inset -1px -1px 2px rgba(0,0,0,0.7), 0 4px 16px -6px rgba(48,84,255,0.55), 0 0 0 1px rgba(120,156,255,0.28), 0 0 10px -2px rgba(120,156,255,0.45); }
      7% { box-shadow: inset 0 0 0 1px rgba(255,255,255,0.09), inset 0 1px 4px rgba(180,210,255,0.38), inset -1px -1px 2px rgba(0,0,0,0.7), 0 4px 20px -6px rgba(90,140,255,0.75), 0 0 0 1px rgba(140,176,255,0.38), 0 0 14px -2px rgba(120,156,255,0.75); }
      14% { box-shadow: inset 0 0 0 1px rgba(255,255,255,0.07), inset 0 1px 3px rgba(160,190,255,0.3), inset -1px -1px 2px rgba(0,0,0,0.7), 0 4px 18px -6px rgba(60,110,255,0.6), 0 0 0 1px rgba(120,156,255,0.3), 0 0 12px -2px rgba(120,156,255,0.55); }
      32% { box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08), inset 0 1px 4px rgba(170,205,255,0.34), inset -1px -1px 2px rgba(0,0,0,0.7), 0 4px 22px -6px rgba(110,170,255,0.8), 0 0 0 1px rgba(150,185,255,0.4), 0 0 18px -2px rgba(130,170,255,0.85); }
      45% { box-shadow: inset 0 0 0 1px rgba(255,255,255,0.075), inset 0 1px 3px rgba(160,190,255,0.3), inset -1px -1px 2px rgba(0,0,0,0.7), 0 4px 16px -6px rgba(48,84,255,0.55), 0 0 0 1px rgba(120,156,255,0.28), 0 0 10px -2px rgba(120,156,255,0.5); }
      57% { box-shadow: inset 0 0 0 1px rgba(255,255,255,0.09), inset 0 1px 4px rgba(185,215,255,0.42), inset -1px -1px 2px rgba(0,0,0,0.72), 0 4px 24px -6px rgba(125,190,255,0.85), 0 0 0 1px rgba(160,195,255,0.45), 0 0 22px -3px rgba(140,185,255,0.9); }
      70% { box-shadow: inset 0 0 0 1px rgba(255,255,255,0.075), inset 0 1px 3px rgba(160,190,255,0.3), inset -1px -1px 2px rgba(0,0,0,0.7), 0 4px 16px -6px rgba(48,84,255,0.55), 0 0 0 1px rgba(120,156,255,0.28), 0 0 11px -2px rgba(120,156,255,0.5); }
      83% { box-shadow: inset 0 0 0 1px rgba(255,255,255,0.085), inset 0 1px 4px rgba(175,205,255,0.36), inset -1px -1px 2px rgba(0,0,0,0.7), 0 4px 21px -6px rgba(95,150,255,0.72), 0 0 0 1px rgba(140,176,255,0.34), 0 0 16px -2px rgba(120,156,255,0.65); }
      100% { box-shadow: inset 0 0 0 1px rgba(255,255,255,0.07), inset 0 1px 3px rgba(160,190,255,0.28), inset -1px -1px 2px rgba(0,0,0,0.7), 0 4px 16px -6px rgba(48,84,255,0.55), 0 0 0 1px rgba(120,156,255,0.28), 0 0 10px -2px rgba(120,156,255,0.45); }
    }
    .panel-light { animation: panelLightningFlicker 6s linear infinite; }
    .score-primary.panel-light { position:relative; }
    .score-primary.panel-light::after {
      content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
      background:
        radial-gradient(circle at 25% 30%, rgba(120,156,255,0.22), rgba(120,156,255,0) 55%),
        radial-gradient(circle at 78% 65%, rgba(120,156,255,0.18), rgba(120,156,255,0) 60%),
        repeating-linear-gradient(115deg, rgba(120,156,255,0.08) 0 2px, rgba(120,156,255,0) 2px 7px),
        linear-gradient(145deg, rgba(255,255,255,0.18), rgba(255,255,255,0) 40%),
        linear-gradient(325deg, rgba(0,0,0,0.55), rgba(0,0,0,0) 45%);
      mix-blend-mode:overlay;
      opacity:.9;
      animation: crackleDrift 12s linear infinite;
    }
    @keyframes crackleDrift { 0% { background-position: 0 0, 0 0, 0 0, 0 0, 0 0; } 100% { background-position: 40px 30px, -40px -30px, 120px 0, 0 0, 0 0; } }
    @media (prefers-reduced-motion: reduce) {
      .panel-light { animation:none; }
      .score-primary.panel-light::after { animation:none; }
    }
    @media (forced-colors: active) {
      .panel-light { animation:none; }
      .score-primary.panel-light::after { background:none; }
    }
    /* --- END STEP 4 --- */
    /* CAP High Score Badge Overlay */
  .cap-high-score-badge { position:fixed; top:16px; left:50%; transform:translateX(-50%); z-index:95; pointer-events:none; }
  /* .cap-high-score-badge.visible retained conceptually; no separate styles needed now */
  .cap-high-score-badge .cap-hs-inner { display:flex; align-items:center; justify-content:center; padding:0; border-radius:18px; position:relative; }
    .cap-high-score-badge .cap-hs-inner:before { content:""; position:absolute; inset:0; background:
        radial-gradient(circle at 25% 35%, rgba(120,156,255,0.25), rgba(120,156,255,0) 60%),
        radial-gradient(circle at 80% 65%, rgba(120,156,255,0.18), rgba(120,156,255,0) 65%),
        repeating-linear-gradient(115deg, rgba(120,156,255,0.10) 0 2px, rgba(120,156,255,0) 2px 7px);
      mix-blend-mode:overlay; opacity:.9; }
  .cap-high-score-badge img { width:120px; height:120px; object-fit:contain; filter:drop-shadow(0 0 22px rgba(120,196,255,0.85)) drop-shadow(0 0 50px rgba(102,209,255,0.55)); animation: capPulse 2.4s ease-in-out infinite; }
  @keyframes capPulse { 0%,100% { filter:drop-shadow(0 0 18px rgba(120,196,255,0.9)) drop-shadow(0 0 46px rgba(102,209,255,0.42)); transform:scale(1); } 50% { filter:drop-shadow(0 0 30px rgba(120,196,255,1)) drop-shadow(0 0 70px rgba(102,209,255,0.75)); transform:scale(1.05); } }
  @media (max-width:600px){ .cap-high-score-badge img { width:86px; height:86px; } }
  @media (prefers-reduced-motion: reduce){ .cap-high-score-badge img { animation:none; } }
  @media (forced-colors: active){ .cap-high-score-badge img { forced-color-adjust:auto; } }
  </style>
</head>
<body>
  <div id="stage">
  <div id="root" class="app-shell">
      <div id="gameWrap" class="card-equal">
        <canvas id="game" width="300" height="600"></canvas>
        <div id="overlay" class="visible">READY</div>
      </div>
      <div class="panel">
        <div class="logo-wrap">
          <img id="gameLogo" alt="Tetris Logo" decoding="async" />
        </div>
        <div class="stats">
          <div id="score" class="stat score-primary emphasis panel-light">
            <div class="stat-top"><span class="stat-label">Score</span><span class="delta" id="scoreDelta"></span></div>
            <span id="scoreVal" class="stat-val">0</span>
            <div class="progress-wrap"><div id="levelProgress" class="progress-bar"></div></div>
            <div class="high-badge" title="High Score"><span class="icon">⭐</span><span id="highVal">0</span></div>
          </div>
          <div class="mini-stats">
            <div id="lines" class="stat mini lines-card"><span class="stat-label">Lines</span><span id="linesVal" class="stat-val">0</span></div>
            <div id="level" class="stat mini level-card"><span class="stat-label">Level</span><span id="levelVal" class="stat-val">1</span></div>
          </div>
        </div>
        <div id="toastLayer" class="toast-layer"></div>
        <div class="panel-bottom">
          <div class="divider" style="margin:6px 0 4px;"></div>
          <div class="panel-actions">
            <button id="startBtn" class="panel-btn" data-variant="primary">Start</button>
            <button id="resetBtn" class="panel-btn" data-variant="secondary">Reset</button>
          </div>
          <div class="divider" style="margin:6px 0 4px;"></div>
          <div class="control-cluster">
            <div class="control-grid">
              <div class="blank"></div>
              <button id="btnUp" title="Rotate (Up Arrow)">▲</button>
              <div class="blank"></div>
              <button id="btnLeft" title="Move Left (Left Arrow)">◀</button>
              <button id="btnDown" title="Soft Drop (Down Arrow)">▼</button>
              <button id="btnRight" title="Move Right (Right Arrow)">▶</button>
              <div class="blank"></div>
              <button id="btnHard" title="Hard Drop (Shift)">⤓</button>
              <div class="blank"></div>
            </div>
            <div class="foot-bar">Arrows Move / Up Rotate / Down Soft Drop / Shift Hard Drop / Space Pause</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script type="module" src="/src/main.ts"></script>
</body>
</html>
